{% extends "shared/base_clean.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% block title %}Edição do Produto{% endblock %}

{% block style %}
<link rel="stylesheet" href="{% static 'products/css/register.css' %}">
{% endblock style %}

{% block main %}
<div class="product-container">
  <div class="text-center mb-4">
    <h1 class="display-5 fw-bold mb-2" style="color: var(--color-primary);">Edição do Produto</h1>
    <p class="text-muted mb-0">Crie e personalize seu produto com variantes e atributos</p>
    {{ form.non_field_errors }}
  </div>

  <form method="post" enctype="multipart/form-data" id="productForm">
    {% csrf_token %}

    <!-- -- PRODUCT FORM -- -->
    <div class="product-card mb-4">
      <h2 class="section-title">Informações do Produto</h2>
      {{ product_form.name|as_crispy_field }}
      {{ product_form.description|as_crispy_field }}

      <div class="upload-container mt-4">
        <label class="upload-box" id="imageUploadBox">
          <div class="upload-content" id="imageUploadContent">
            <p id="imageUploadText">Clique para fazer upload da imagem</p>
            <p class="upload-subtext">Formatos suportados: JPG, PNG, WEBP (máx. 5MB)</p>
          </div>
          <div class="image-preview align-items-center justify-content-center text-center row">
          {{ product_form.image }}
          </div>
        </label>
      </div>


    </div>

    <!-- -- VARIANT FORMSET -- -->
<div class="product-card mb-4">
  <h2 class="section-title">Variantes do Produto</h2>

  {# management form é obrigatório #}
  {{ variant_formset.management_form }}
  {% comment %} {{ variant_formset.non_form_errors }} {% endcomment %}

  <div id="variantsContainer">
    {# cada form do formset vira um card de variante #}
    {% for form in variant_formset.forms %}
      <div class="card variant-card mb-3 p-3" data-index="{{ forloop.counter0 }}" style="{% if form.hidden_in_template %}display:none;{% endif %}">
        
        {# CAMPOS OCULTOS DA VARIANTE (ID e DELETE) #}
        {% for hidden in form.hidden_fields %}
          {{ hidden }}
        {% endfor %}

        <div class="d-flex justify-content-between align-items-start">
          <h5 class="mb-0">Variante {{ forloop.counter }}</h5>
          <div>
            <button type="button" class="btn btn-sm btn-danger remove-variant">Remover</button>
          </div>
        </div>

        <div class="variant-fields mt-2">
          {% for field in form.visible_fields %}
            <div class="mb-2">
              {{ field|as_crispy_field }}
            </div>
          {% endfor %}
        </div>

        <hr>

        <div class="nested-images-wrapper">
            {{ form.nested_images.management_form }}
            {% if form.nested_images.non_form_errors %}
            <div class="alert alert-danger">
              {% for error in form.nested_images.non_form_errors %}
                <p>{{ error }}</p>
              {% endfor %}
            </div>
          {% endif %}

            <h6>Imagens da Variante</h6>
            <div class="image-list mb-2 d-flex flex-wrap gap-3">
              {% for image_form in form.nested_images.forms %}
                <div class="image-item-container">
                  
                  <label class='label-image' for="{{ image_form.image.id_for_label }}">
                    <div class="upload-box position-relative d-inline-block me-2 mb-2 align-items-center justify-content-center text-center" style="max-width: 217.5px;">
                          {# IDs ocultos da imagem específica #}
                          {% for hidden in image_form.hidden_fields %}
                              {{ hidden }}
                          {% endfor %}
                            <div class="image-preview align-items-center justify-content-center text-center row">
                                {{ image_form.image }}
                            </div>
                            <div class='mt-2 me-2' style="position: absolute; top: 0; right: 0;">
                                <button type="button" class="btn btn-danger btn-sm remove-image" onclick="removeImage(this)">X</button>
                            </div>
                        </div>
                    </label>
                </div>
              {% endfor %}
              <div class='addImage upload-box position-relative d-inline-block me-2 mb-2 align-content-center'>
                + imagens
              </div>
            </div>
        </div>

        <hr>

        <div class="nested-attributes-wrapper">
            {{ form.nested_attributes.management_form }}
            {{ form.nested_attributes.non_form_errors }}

            <h6 class="mb-0">Atributos</h6>
            <div class="attribute-list mb-2">

              {% for attribute_form in form.nested_attributes.forms %}
                <div class="row g-2 mb-2 attribute-row">
                  {# IDs ocultos do atributo específico #}
                  {% for hidden in attribute_form.hidden_fields %}
                    {{ hidden }}
                  {% endfor %}
                  
                  <div class="col-md-5">
                    {{ attribute_form.attribute|as_crispy_field }}
                  </div>
                  <div class="col-md-5">
                    {{ attribute_form.value|as_crispy_field }}
                  </div>
                  <div class="col-md-2 d-flex align-items-center mb-sm-0 mb-2">
                    <button type="button" class="btn btn-danger btn-sm remove-attribute mt-md-3">remover</button>
                  </div>
                </div>
              {% endfor %}
            </div>
            <div class="d-flex gap-2 mt-2">
              <button type="button" class="btn btn-sm btn-secondary add-attribute">+ Atributo</button>
            </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>
      {% include "products/partials/template.html" %}
    <!-- SUBMIT -->
    <div class="submit-section mt-4">
      <button type="submit" class="btn btn-submit btn-primary">
        <i class="bi bi-check2-circle"></i> Editar Produto
      </button>
    </div>
  </form>
</div>


      
{% endblock main %}




{% block scripts %}
<script src="{% static 'products/js/edit.js' %}"></script>
<script>
function removeImage(button) {
    const imageLabel = button.closest('.label-image');
    if (!imageLabel) return;

    const card = imageLabel.closest('.variant-card');
    const container = imageLabel.closest('.image-list');
    const idInput = imageLabel.querySelector('input');
    const deleteInput = imageLabel.querySelector('input[name$="-DELETE"]');

    if (idInput && idInput.value) {
        deleteInput.value = 'on';
        deleteInput.checked = true;
        imageLabel.style.display = 'none';
        imageLabel.classList.add('is-deleted');
    } else {
        imageLabel.style.display = 'none';
    }

}

</script>
{% endblock scripts %}

