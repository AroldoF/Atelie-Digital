{% extends "shared/base.html" %}
{% load static %}

{% block title %}Detalhes do Pedido #{{ order.pk|stringformat:"06d" }}{% endblock %}

{% block style %}
<link rel="stylesheet" href="{% static 'orders/css/shared/detail_order.css' %}">
{% endblock style %}

{% block main %}
<div class="confirmation-wrapper">
    <div class="confirmation-card">
        
        <!-- Header -->
        <header class="success-header">
            <!-- Ícone Condicional -->
            <div class="success-icon-container {% if order.status == 'CANCELLED' %}cancelled{% endif %}">
                {% if order.status == 'CANCELLED' %}
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                {% else %}
                    <!-- Check normal -->
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                {% endif %}
            </div>

            <!-- Título Dinâmico -->
            <h1 class="success-title">
                {% if order.status == 'PENDING' %}Pedido Recebido
                {% elif order.status == 'IN_PROGRESS' %}Em Processamento
                {% elif order.status == 'COMPLETED' %}Pedido Entregue
                {% elif order.status == 'CANCELLED' %}Pedido Cancelado
                {% endif %}
            </h1>
            
            <p class="success-subtitle">{{ order.created_at|date:"d \d\e F \d\e Y" }}</p>
            
            <div style="margin-top: 1rem;">
                <span style="background: var(--color-background); padding: 4px 12px; border-radius: 99px; font-size: var(--font-size-xs); font-family: var(--font-family-mono); color: var(--color-text-muted);">
                    #{{ order.order_code }}
                </span>
            </div>
        </header>

        <!-- Pacote (Itens da Loja) -->
        <div class="package-group">
            <div class="package-header">
                <div class="store-info">
                    <svg class="store-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    <span>Vendido por <strong>{{ order.store.name }}</strong></span>
                </div>
                
                <!-- Badge de Status Dinâmico -->
                {% if order.status == 'PENDING' %}
                    <span class="status-badge status-pending">Pendente</span>
                {% elif order.status == 'IN_PROGRESS' %}
                    <span class="status-badge status-processing">Em Andamento</span>
                {% elif order.status == 'COMPLETED' %}
                    <span class="status-badge status-delivered">Entregue</span>
                {% elif order.status == 'CANCELLED' %}
                    <span class="status-badge status-cancelled">Cancelado</span>
                {% endif %}
            </div>

            <div class="package-items">
                {% for item in order.items.all %}
                <div class="item-row">
                    <div class="item-image">
                        {% if item.product_variant.product.image %}
                            <img src="{{ item.product_variant.product.image.url }}" alt="{{ item.product_variant.product.name }}">
                        {% else %}
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                        {% endif %}
                    </div>
                    <div class="item-details">
                        <span class="item-name">{{ item.product_variant.product.name }}</span>
                        <span class="item-meta">
                            Qtd: {{ item.quantity }}
                            {% if item.product_variant.description %}
                             • {{ item.product_variant.description }}
                            {% endif %}
                        </span>
                    </div>
                    <span class="item-price">R$ {{ item.subtotal|floatformat:2 }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Infos de Pagamento e Endereço -->
        <section class="info-grid">
            <div class="info-group">
                <h5>Endereço de Entrega</h5>
                <!-- Lógica de Fallback se o objeto order.address não existir diretamente -->
                {% if order.user.addresses.exists %}
                    {% with addr=order.user.addresses.first %}
                        <p>{{ addr.street }}, {{ addr.number }}<br>
                        {{ addr.neighborhood }}<br>
                        {{ addr.city }} - {{ addr.state }}</p>
                    {% endwith %}
                {% else %}
                    <p>Endereço registrado na conta.</p>
                {% endif %}
            </div>
            <div class="info-group">
                <h5>Pagamento</h5>
                <p>Pagamento via Sistema<br>Total: R$ {{ order.total_amount|floatformat:2 }}</p>
            </div>
        </section>

        <!-- Totais -->
        <section class="order-totals">
            <div class="total-row">
                <span>Subtotal</span>
                <span>R$ {{ order.total_amount|floatformat:2 }}</span>
            </div>
            <!-- Exemplo de Frete (Se tiver lógica futura) -->
            <!--
            <div class="total-row">
                <span>Frete</span>
                <span>R$ 0,00</span>
            </div>
            -->
            <div class="total-row final">
                <span>Total</span>
                <span id="price">R$ {{ order.total_amount|floatformat:2 }}</span>
            </div>
        </section>

        <!-- Botões -->
        <footer class="action-buttons">
            <a href="{% url 'accounts:orders' %}" class="btn btn-primary">
                Acompanhar Meus Pedidos
            </a>
        </footer>

    </div>
</div>
{% endblock %}